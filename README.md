# Flicker

A photo social network that removes backgrounds and flips images. Processing runs entirely in the browser.

## Architecture

- **Client-heavy**: All image processing runs in the browser
- **Frontend**: Next.js 16 + React 19 + Tailwind CSS
- **Image processing**: WASM-based ML model (`@imgly/background-removal`) removes backgrounds, Canvas API flips horizontally
- **Upload**: Processed PNGs upload directly from client to Supabase Storage
- **Backend**: Entirely Supabase (Postgres, Storage, Auth)
- **Server actions**: Handle database operations and user ownership verification
- **Anonymous users**: Session ID in localStorage, images expire in 3 days
- **Authenticated users**: Email verified via Supabase Auth, images saved permanently
- **Cleanup**: Daily Vercel cron job deletes expired images from Storage and database

## Assumptions

**No need for multiple uploads at once**

This keeps the implementation simple and avoids browser memory issues from parallel WASM execution.

## Scaling for Simultaneous Uploads

If multiple simultaneous uploads were needed, the architecture would change:

1. **Queue System**: Use a job queue (BullMQ, AWS SQS, etc.)
2. **Server-Side Processing**: Move background removal to cloud functions or workers
3. **Chunked Uploads**: Upload original images, process in batches server-side

## Setup

### Prerequisites

- Node.js 20+
- Supabase project (free tier works)

### Environment Variables

Create `.env.local`:

```env
# Supabase
NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_KEY=
NEXT_PRIVATE_SUPABASE_KEY=

# Vercel Cron Secret (auto-generated by Vercel in production)
CRON_SECRET=
```

### Supabase Setup

1. Create a new Supabase project
2. Run the following SQL in the SQL Editor:

```sql
-- Users table
create table users (
  id uuid primary key default gen_random_uuid(),
  session_id text unique not null,
  email text unique,
  email_verified boolean default false,
  created_at timestamptz default now()
);

-- Images table
create table images (
  id uuid primary key default gen_random_uuid(),
  user_id uuid references users(id) on delete cascade,
  blob_url text not null,
  original_filename text,
  file_size integer,
  is_public boolean default false,
  expires_at timestamptz,
  created_at timestamptz default now()
);

-- Indexes
create index idx_images_user_id on images(user_id);
create index idx_images_expires_at on images(expires_at);
create index idx_images_is_public on images(is_public);
```

3. Create a storage bucket named `images` with public access
4. Enable email auth in Authentication settings

### Install & Run

```bash
npm install
npm run dev
```

Open [http://localhost:3000](http://localhost:3000).

### Deploy to Vercel

1. Push to GitHub
2. Import in Vercel
3. Add environment variables
4. Add cron job in `vercel.json` (already configured):

```json
{
  "crons": [{
    "path": "/api/cron/cleanup",
    "schedule": "0 0 * * *"
  }]
}
```

## Tech Stack

- **Framework**: Next.js 16 (App Router)
- **UI**: React 19 + Tailwind CSS 4
- **Database**: Supabase Postgres
- **Storage**: Supabase Storage
- **Auth**: Supabase Auth
- **Image Processing**: @imgly/background-removal (browser WASM)
